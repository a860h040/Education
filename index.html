<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF → Word (.docx) Converter</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:980px}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:#0b74ff;color:#fff}
    .muted{color:#666;font-size:14px;line-height:1.4}
    progress{width:100%;height:14px}
    .log{white-space:pre-wrap;background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:12px;font-size:13px}
    .warn{background:#fff7e6;border:1px solid #ffe2a8;padding:10px;border-radius:10px;margin-top:12px}
    code{background:#f2f2f2;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>PDF → Word (.docx) Converter</h1>

  <div class="card">
    <div class="row">
      <input id="pdfFile" type="file" accept="application/pdf" />
      <button id="convertBtn" class="primary" disabled>Convert to Word</button>
      <button id="downloadBtn" disabled>Download .docx</button>
    </div>

    <div class="warn">
      <div><strong>Important limitations</strong></div>
      <div class="muted">
        This runs in the browser and extracts text from the PDF to rebuild a Word file.
        It will not perfectly preserve layout (tables/columns/fonts). Scanned PDFs need OCR (not included).
      </div>
      <div class="muted" style="margin-top:6px">
        If you run this in <b>W3Schools Tryit</b>, CDNs may be blocked and you may get <code>pdfjsLib is not defined</code>.
        Use GitHub Pages or a normal hosted page.
      </div>
    </div>

    <div style="margin-top:14px">
      <progress id="prog" value="0" max="100"></progress>
      <div id="status" class="muted" style="margin-top:6px">Loading libraries…</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const pdfInput = $("pdfFile");
    const convertBtn = $("convertBtn");
    const downloadBtn = $("downloadBtn");
    const prog = $("prog");
    const status = $("status");
    const logEl = $("log");

    let lastDocBlob = null;
    let lastName = "converted.docx";

    function setStatus(msg) { status.textContent = msg; }
    function appendLog(msg) { logEl.textContent += msg + "\n"; }
    function setProgress(pct) { prog.value = Math.max(0, Math.min(100, pct)); }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    async function loadLibraries() {
      // PDF.js (UMD global: pdfjsLib)
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js");
      if (!window.pdfjsLib) throw new Error("pdfjsLib did not load (PDF.js blocked?)");

      // PDF.js worker
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

      // docx (UMD global: docx)
      await loadScript("https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js");
      if (!window.docx) throw new Error("docx library did not load (blocked?)");

      // FileSaver (global: saveAs)
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js");
      if (!window.saveAs) throw new Error("FileSaver did not load (blocked?)");
    }

    // Group PDF.js text items into lines (simple heuristic)
    function itemsToLines(items) {
      const normalized = items
        .filter(it => it.str && it.str.trim().length)
        .map(it => ({
          text: it.str,
          x: it.transform[4],
          y: it.transform[5],
          w: it.width || 0
        }))
        .sort((a,b) => (b.y - a.y) || (a.x - b.x));

      const linesMap = new Map();
      const yTolerance = 2;

      for (const it of normalized) {
        let key = null;
        for (const k of linesMap.keys()) {
          if (Math.abs(k - it.y) <= yTolerance) { key = k; break; }
        }
        if (key === null) key = it.y;
        if (!linesMap.has(key)) linesMap.set(key, []);
        linesMap.get(key).push(it);
      }

      const lineKeys = Array.from(linesMap.keys()).sort((a,b) => b - a);
      const lines = [];

      for (const y of lineKeys) {
        const row = linesMap.get(y).sort((a,b) => a.x - b.x);
        let line = "";
        let prevX = null;

        for (const chunk of row) {
          if (prevX !== null && (chunk.x - prevX) > 6 && !line.endsWith(" ")) line += " ";
          line += chunk.text;
          prevX = chunk.x + (chunk.w || 0);
        }

        line = line.replace(/\s+/g, " ").trim();
        if (line) lines.push(line);
      }

      return lines;
    }

    pdfInput.addEventListener("change", () => {
      lastDocBlob = null;
      downloadBtn.disabled = true;
      if (pdfInput.files && pdfInput.files[0]) {
        setStatus(`Selected: ${pdfInput.files[0].name}`);
        lastName = pdfInput.files[0].name.replace(/\.pdf$/i, "") + ".docx";
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!lastDocBlob) return;
      saveAs(lastDocBlob, lastName);
    });

    convertBtn.addEventListener("click", async () => {
      const file = pdfInput.files?.[0];
      if (!file) return;

      convertBtn.disabled = true;
      downloadBtn.disabled = true;
      lastDocBlob = null;
      logEl.textContent = "";
      setProgress(0);

      try {
        appendLog("Reading file…");
        setStatus("Reading PDF…");

        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;

        const total = pdf.numPages;
        appendLog(`Pages: ${total}`);
        setStatus(`Extracting text from ${total} pages…`);

        const docChildren = [];

        for (let pageNo = 1; pageNo <= total; pageNo++) {
          setStatus(`Processing page ${pageNo}/${total}…`);
          setProgress(Math.round(((pageNo - 1) / total) * 100));

          const page = await pdf.getPage(pageNo);
          const textContent = await page.getTextContent();

          const lines = itemsToLines(textContent.items);
          appendLog(`Page ${pageNo}: ${lines.length} line(s)`);

          for (const line of lines) {
            docChildren.push(
              new docx.Paragraph({ children: [new docx.TextRun({ text: line })] })
            );
          }
          if (pageNo < total) {
            docChildren.push(new docx.Paragraph({ children: [new docx.PageBreak()] }));
          }
        }

        setStatus("Building .docx…");
        setProgress(95);

        const doc = new docx.Document({
          sections: [{ properties: {}, children: docChildren }]
        });

        lastDocBlob = await docx.Packer.toBlob(doc);

        setProgress(100);
        setStatus("Done. Click Download .docx");
        downloadBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("Error: " + (err?.message || String(err)));
        appendLog("ERROR: " + (err?.stack || err?.message || String(err)));
      } finally {
        convertBtn.disabled = false;
      }
    });

    // Boot: load libs, then enable convert (once a file is picked)
    (async () => {
      try {
        await loadLibraries();
        setStatus("Libraries loaded. Choose a PDF.");
        appendLog("Libraries loaded OK.");
        // Enable convert button only when a file is selected
        convertBtn.disabled = !(pdfInput.files && pdfInput.files[0]);
        pdfInput.addEventListener("change", () => {
          convertBtn.disabled = !(pdfInput.files && pdfInput.files[0]);
        });
      } catch (e) {
        setStatus("Library load failed. This environment may block CDNs.");
        appendLog("ERROR: " + (e?.message || String(e)));
        appendLog("Fix: run this on GitHub Pages / normal hosting (not W3Schools Tryit).");
      }
    })();
  </script>
</body>
</html>
