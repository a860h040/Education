<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PDF Vault</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:24px;max-width:980px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:#333;margin-bottom:4px}
    input,button{font:inherit;padding:10px;border:1px solid #ccc;border-radius:10px}
    input[type=file]{padding:8px}
    button{cursor:pointer}
    button.primary{border:none;background:#111;color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{white-space:pre-wrap;background:#fafafa;border:1px dashed #ddd;border-radius:12px;padding:10px;min-height:54px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{font-size:13px;color:#444}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all}
    .muted{color:#666;font-size:13px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444}
    .hidden{display:none}
  </style>
</head>
<body>
<h1>PDF Vault</h1>
<div class="muted">Front-end: GitHub Pages. Backend: Apps Script (token + login stored in Google Sheet).</div>

<script>
  // ✅ replace with your newest /exec URL after redeploy
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztzNiKz3FurICloFczVB7QAtCc4S_6l0jpctvE9MrUk9jT5NMVIcvKipHjHtLN7BALDw/exec";
</script>

<div class="card" id="loginCard">
  <h3 style="margin:0 0 10px;">Login</h3>
  <div class="row">
    <div style="flex:1;min-width:240px;">
      <label>Username</label>
      <input id="username" autocomplete="username">
    </div>
    <div style="flex:1;min-width:240px;">
      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password">
    </div>
    <div style="align-self:end;">
      <button class="primary" id="loginBtn">Login</button>
    </div>
  </div>
</div>

<div id="app" class="hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <div class="muted">Repository:</div>
        <div class="mono" id="repoLabel">Loading…</div>
      </div>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Upload PDF</h3>
    <div class="row">
      <div style="flex:1;min-width:320px;">
        <label>Select PDF</label>
        <input id="file" type="file" accept="application/pdf">
      </div>
      <div style="align-self:end;">
        <button class="primary" id="uploadBtn">Upload</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Find & Download</h3>
    <div class="row">
      <div style="flex:1;min-width:260px;">
        <label>Search by filename</label>
        <input id="search" placeholder="type part of a filename…">
      </div>
      <div style="align-self:end;">
        <button id="refreshBtn">List PDFs</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>File</th>
            <th>Size</th>
            <th>Raw link</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">Click “List PDFs”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 10px;">Status</h3>
  <div id="status" class="status muted">Ready.</div>
</div>

<!-- Hidden form used for POST to Apps Script (targets popup) -->
<form id="apiForm" method="POST" class="hidden">
  <input name="action"  id="f_action">
  <input name="nonce"   id="f_nonce">
  <input name="session" id="f_session">
  <input name="username" id="f_username">
  <input name="password" id="f_password">
  <input name="filename" id="f_filename">
  <textarea name="base64" id="f_base64"></textarea>
</form>

<script>
  const $ = (id) => document.getElementById(id);
  let session = localStorage.getItem("pdfVaultSession") || "";
  let lastFiles = [];

  function setStatus(m){ $("status").textContent = m; }
  function showApp(on){
    $("app").classList.toggle("hidden", !on);
    $("loginCard").classList.toggle("hidden", on);
  }

  function niceBytes(n){
    n = Number(n || 0);
    if (!n) return "0 B";
    const k=1024, sizes=["B","KB","MB","GB"];
    const i=Math.floor(Math.log(n)/Math.log(k));
    return (n/Math.pow(k,i)).toFixed(i?2:0) + " " + sizes[i];
  }
  function esc(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ---------- JSONP (GET config/list) ----------
  function jsonp(url, prefix){
    return new Promise((resolve, reject) => {
      const cb = `${prefix}_${Math.random().toString(16).slice(2)}`;
      window[cb] = (data) => {
        delete window[cb];
        script.remove();
        resolve(data);
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
      script.onerror = () => {
        delete window[cb];
        script.remove();
        reject(new Error("JSONP failed (blocked or wrong URL)."));
      };
      document.body.appendChild(script);
    });
  }

  async function loadConfig(){
    const data = await jsonp(`${SCRIPT_URL}?action=config`, "cfg");
    if (!data.ok) throw new Error(data.message || "Config error");
    $("repoLabel").textContent = `${data.owner}/${data.repo}@${data.branch}  (folder: ${data.folder})`;
  }

  function render(files){
    const tbody = $("tbody");
    const q = $("search").value.trim().toLowerCase();
    const filtered = q ? files.filter(f => (f.name||"").toLowerCase().includes(q)) : files;

    if (!filtered.length){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">No matching PDFs.</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    for (const f of filtered){
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.innerHTML = `<strong>${esc(f.name)}</strong><div class="muted mono">${esc(f.path)}</div>`;
      tr.appendChild(td1);

      const td2 = document.createElement("td");
      td2.innerHTML = `<span class="pill">${niceBytes(f.size)}</span>`;
      tr.appendChild(td2);

      const td3 = document.createElement("td");
      td3.innerHTML = `<div class="mono">${esc(f.raw_url)}</div>`;
      tr.appendChild(td3);

      const td4 = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Download";
      btn.onclick = () => window.open(f.raw_url, "_blank", "noopener,noreferrer");
      td4.appendChild(btn);
      tr.appendChild(td4);

      tbody.appendChild(tr);
    }
  }

  async function listPDFs(){
    if (!session) return setStatus("Login first.");
    setStatus("Listing PDFs…");
    $("refreshBtn").disabled = true;

    try{
      const data = await jsonp(`${SCRIPT_URL}?action=list&session=${encodeURIComponent(session)}`, "lst");
      if (!data.ok) throw new Error(data.message || "List error");
      lastFiles = data.files || [];
      render(lastFiles);
      setStatus(`✅ Found ${lastFiles.length} PDF(s).`);
    } catch(e){
      setStatus("ERROR: " + e.message);
      if ((e.message||"").toLowerCase().includes("session")) forceLogout();
    } finally {
      $("refreshBtn").disabled = false;
    }
  }

  // ---------- POST via POPUP + postMessage ----------
  function postPopup(action, fields){
    return new Promise((resolve, reject) => {
      const nonce = "n_" + Math.random().toString(16).slice(2) + "_" + Date.now();

      const popupName = "apiPopup_" + Date.now();
      const popup = window.open("about:blank", popupName, "width=520,height=640");
      if (!popup) return reject(new Error("Popup blocked. Allow popups for this site."));

      const form = $("apiForm");
      form.action = SCRIPT_URL;
      form.target = popupName;

      $("f_action").value = action;
      $("f_nonce").value = nonce;
      $("f_session").value = fields.session || "";
      $("f_username").value = fields.username || "";
      $("f_password").value = fields.password || "";
      $("f_filename").value = fields.filename || "";
      $("f_base64").value = fields.base64 || "";

      const timeout = setTimeout(() => {
        window.removeEventListener("message", handler);
        try { popup.close(); } catch(e){}
        reject(new Error("No response from Apps Script. (Is the web app authorized + set to Anyone?)"));
      }, 15000);

      const handler = (ev) => {
        const msg = ev.data || {};
        // Only accept matching action + nonce
        if (!msg || msg.type !== action || msg.nonce !== nonce) return;
        clearTimeout(timeout);
        window.removeEventListener("message", handler);
        try { popup.close(); } catch(e){}
        msg.ok ? resolve(msg) : reject(new Error(msg.message || "Request failed"));
      };

      window.addEventListener("message", handler);
      form.submit();
    });
  }

  async function doLogin(){
    const u = $("username").value.trim();
    const p = $("password").value.trim();
    if (!u || !p) return setStatus("Enter username and password.");

    $("loginBtn").disabled = true;
    setStatus("Logging in…");

    try{
      const res = await postPopup("login", { username:u, password:p });
      session = res.session;
      localStorage.setItem("pdfVaultSession", session);
      showApp(true);
      setStatus(`✅ Logged in (expires ~${res.expiresHours} hours).`);
      await loadConfig();
    } catch(e){
      setStatus("ERROR: " + e.message);
    } finally {
      $("loginBtn").disabled = false;
      $("password").value = "";
    }
  }

  function forceLogout(){
    localStorage.removeItem("pdfVaultSession");
    session = "";
    showApp(false);
  }

  async function doLogout(){
    const s = session;
    forceLogout();
    try { await postPopup("logout", { session:s }); } catch {}
    setStatus("Logged out.");
  }

  async function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = () => reject(fr.error);
      fr.readAsDataURL(file);
    });
  }

  async function upload(){
    if (!session) return setStatus("Login first.");
    const file = $("file").files[0];
    if (!file) return setStatus("Pick a PDF first.");
    if (file.type !== "application/pdf" && !file.name.toLowerCase().endsWith(".pdf")) {
      return setStatus("Please choose a PDF.");
    }

    $("uploadBtn").disabled = true;
    setStatus("Reading file…");

    try{
      const dataUrl = await fileToDataUrl(file);
      setStatus("Uploading…");

      const res = await postPopup("upload", { session, filename: file.name, base64: dataUrl });

      setStatus(`✅ Uploaded:\n${res.name}\n\nRaw link:\n${res.raw_url}`);
      $("file").value = "";
      await listPDFs();
    } catch(e){
      setStatus("ERROR: " + e.message);
      if ((e.message||"").toLowerCase().includes("session")) forceLogout();
    } finally {
      $("uploadBtn").disabled = false;
    }
  }

  $("loginBtn").addEventListener("click", doLogin);
  $("logoutBtn").addEventListener("click", doLogout);
  $("refreshBtn").addEventListener("click", listPDFs);
  $("uploadBtn").addEventListener("click", upload);
  $("search").addEventListener("input", () => render(lastFiles));

  // Auto session
  if (session) {
    showApp(true);
    loadConfig()
      .then(() => setStatus("Session found. Ready."))
      .catch(() => forceLogout());
  } else {
    showApp(false);
  }
</script>
</body>
</html>
